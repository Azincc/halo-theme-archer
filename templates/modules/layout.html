<!doctype html>
<html
    th:lang="${#locale.toLanguageTag}"
    xmlns:th="http://www.thymeleaf.org"
    th:fragment="html (content, page_js, _title, _templateId)"
    th:with="templateId=${_templateId != null ? _templateId : 'index'}"
>
    <head th:replace="~{modules/head :: head(${_title}, ${templateId})}"></head>

    <body
        th:with="bodyClass=${templateId == 'index' ? 'home-body' : templateId == 'post' ? 'post-body' : templateId == 'about' ? 'about-body' : templateId == '404' ? 'about-body error-body' : ''}"
        th:class="${bodyClass}"
        th:classappend="${#authentication.name != 'anonymousUser'} ? ' logged-in'"
    >
        <th:block th:replace="~{modules/header :: header}"></th:block>

        <th:block th:replace="~{modules/footer-fixed :: footer-fixed(templateId=${templateId})}"></th:block>

        <div class="wrapper">
            <th:block th:replace="~{fragment/intro::html(${templateId})}" />

            <img
                class="loading"
                th:src="@{/assets/loading.svg}"
                style="display: block; margin: 6rem auto 0 auto; width: 6rem; height: 6rem"
                alt="loading"
            />

            <div class="container container-unloaded">
                <th:block th:replace="${content}" />
            </div>

            <th:block th:replace="~{modules/footer :: footer}"></th:block>
        </div>

        <!-- TOC -->
        <th:block th:if="${templateId == 'post' and (theme.config.style.toc ?: true)}">
            <th:block th:replace="~{modules/toc :: toc}"></th:block>
        </th:block>

        <!-- Sidebar -->
        <th:block th:replace="~{modules/sidebar :: sidebar}"></th:block>

        <!-- Site metadata for sidebar JavaScript -->
        <th:block th:replace="~{modules/sidebar :: site-meta}"></th:block>

        <script th:src="@{/assets/dist/main.js}" type="module"></script>
        <script th:inline="javascript">
            (function () {
                var scheme = /*[[${theme.config.style.color_scheme}]]*/ 'system';
                window.__archerMainCallbacks = window.__archerMainCallbacks || [];
                window.__archerMainCallbacks.push(function (mainModule) {
                    if (mainModule && typeof mainModule.initializeColorScheme === 'function') {
                        mainModule.initializeColorScheme(scheme);
                    }
                });
                if (window.main && typeof window.main.initializeColorScheme === 'function') {
                    window.main.initializeColorScheme(scheme);
                }
            })();
        </script>
        <script
            src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.36/dist/fancybox/fancybox.umd.js"
            onload="window.Fancybox && window.Fancybox.bind('[data-fancybox]')"
            defer
        ></script>

        <th:block th:if="${theme.config.analytics?.busuanzi?.enable == true}">
            <script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>
        </th:block>

        <th:block th:if="${templateId == 'post'}">
            <script th:src="@{/assets/dist/share.js}" type="module"></script>
        </th:block>

        <!-- Mermaid Diagrams -->
        <th:block th:if="${templateId == 'post' and (theme.config.other.mermaid?.enable ?: false)}">
            <script
                src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"
                th:data-theme="${theme.config.other.mermaid.theme ?: 'default'}"
                data-cfasync="false"
                onload="
                    (function () {
                        if (!window.mermaid) return;
                        var configTheme = this.dataset.theme;
                        var mermaidSources = [];

                        function getMermaidTheme() {
                            if (configTheme === 'auto') {
                                return document.documentElement.classList.contains('dark') ? 'dark' : 'default';
                            }
                            return configTheme;
                        }

                        function renderMermaid() {
                            var theme = getMermaidTheme();
                            window.mermaid.initialize({ startOnLoad: false, theme: theme });

                            mermaidSources.forEach(function (item, i) {
                                var container = document.getElementById(item.id);
                                if (container) {
                                    container.removeAttribute('data-processed');
                                    container.innerHTML = item.source;
                                }
                            });

                            window.mermaid.run();
                        }

                        // Convert mermaid code blocks and save sources
                        var blocks = document.querySelectorAll('code.language-mermaid, code[class*=language-mermaid]');
                        blocks.forEach(function (code, i) {
                            var pre = code.closest('pre');
                            var wrapper = pre ? pre.closest('shiki-code') || pre : code;
                            var source = code.textContent.trim();
                            var id = 'mermaid-' + Date.now() + '-' + i;

                            mermaidSources.push({ id: id, source: source });

                            var div = document.createElement('div');
                            div.className = 'mermaid';
                            div.id = id;
                            div.textContent = source;
                            if (wrapper.parentNode) wrapper.parentNode.replaceChild(div, wrapper);
                        });

                        // Initial render
                        renderMermaid();

                        // Watch for theme changes
                        if (configTheme === 'auto') {
                            var observer = new MutationObserver(function (mutations) {
                                mutations.forEach(function (mutation) {
                                    if (mutation.attributeName === 'class') {
                                        renderMermaid();
                                    }
                                });
                            });
                            observer.observe(document.documentElement, {
                                attributes: true,
                                attributeFilter: ['class'],
                            });
                        }
                    }).call(this)
                "
            ></script>
        </th:block>

        <!-- MathJax LaTeX -->
        <th:block th:if="${templateId == 'post' and (theme.config.other.math?.enable ?: false)}">
            <script data-cfasync="false">
                window.MathJax = {
                    tex: {
                        inlineMath: [
                            ['$', '$'],
                            ['\\(', '\\)'],
                        ],
                        displayMath: [
                            ['$$', '$$'],
                            ['\\[', '\\]'],
                        ],
                        processEscapes: true,
                    },
                    options: {
                        skipHtmlTags: ['script', 'noscript', 'style', 'textarea'],
                    },
                    startup: {
                        pageReady: function () {
                            // Convert latex code blocks before typesetting
                            var blocks = document.querySelectorAll(
                                'code.language-latex, code.language-math, code[class*=language-latex], code[class*=language-math]',
                            );
                            blocks.forEach(function (code) {
                                var pre = code.closest('pre');
                                var wrapper = pre ? pre.closest('shiki-code') || pre : code;
                                var content = code.textContent.trim();
                                var div = document.createElement('div');
                                div.className = 'mathjax-block';
                                // Check if already has delimiters
                                if (/^\$\$[\s\S]*\$\$$/.test(content) || /^\\\[[\s\S]*\\\]$/.test(content)) {
                                    div.textContent = content;
                                } else {
                                    div.textContent = '$$' + content + '$$';
                                }
                                if (wrapper.parentNode) wrapper.parentNode.replaceChild(div, wrapper);
                            });
                            return MathJax.startup.defaultPageReady();
                        },
                    },
                };
            </script>
            <script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" data-cfasync="false"></script>
        </th:block>

        <th:block th:if="${page_js != null}" th:replace="${page_js}" />

        <!-- Halo 代码注入：页脚 -->
        <halo:footer />
    </body>
</html>
